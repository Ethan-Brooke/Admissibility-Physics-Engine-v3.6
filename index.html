<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admissibility Physics Engine v3.6</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,500;0,600;0,700&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<style>
/* ═══════ CORE ═══════ */
:root {
  --bg: #060810; --card: #0b0f1a; --card2: #0e1322; --border: #171e30;
  --text: #c8cedf; --dim: #4a5575; --bright: #eef0f8;
  --green: #34d399; --green2: #059669; --green-g: #34d39925;
  --blue: #60a5fa; --blue-g: #60a5fa20;
  --purple: #a78bfa; --purple-g: #a78bfa1a;
  --amber: #fbbf24; --amber-g: #fbbf2418;
  --red: #f87171; --red-g: #f871711a;
  --pink: #f472b6; --indigo: #818cf8; --cyan: #22d3ee;
  --mono: 'IBM Plex Mono', monospace; --sans: 'IBM Plex Sans', sans-serif;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: var(--sans); background: var(--bg); color: var(--text); min-height: 100vh; }
.container { max-width: 1060px; margin: 0 auto; padding: 28px 20px; }

/* ═══════ HEADER ═══════ */
.hdr { margin-bottom: 28px; position: relative; }
.hdr::after {
  content: ''; position: absolute; bottom: -14px; left: 0; width: 100%;
  height: 1px; background: linear-gradient(90deg, var(--green), var(--blue), var(--purple), transparent 80%);
  opacity: .6;
}
.hdr-tag { font-family: var(--mono); font-size: 10px; font-weight: 600; color: var(--green); letter-spacing: 3px; text-transform: uppercase; }
.hdr-title { font-size: 26px; font-weight: 700; color: var(--bright); letter-spacing: -0.5px; margin-top: 2px; }
.hdr-sub { font-family: var(--mono); font-size: 11px; color: var(--dim); margin-top: 4px; }
.hdr-sub b { color: var(--green); font-weight: 500; }

/* ═══════ SUMMARY CARDS ═══════ */
.sg { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 24px; }
.sc {
  background: var(--card); border: 1px solid var(--border); border-radius: 6px;
  padding: 13px 15px; position: relative; overflow: hidden;
}
.sc::before { content:''; position: absolute; top: 0; left: 0; right: 0; height: 2px; }
.sc[data-a="g"]::before { background: var(--green); }
.sc[data-a="b"]::before { background: var(--blue); }
.sc[data-a="p"]::before { background: var(--purple); }
.sc[data-a="a"]::before { background: var(--amber); }
.sc-l { font-family: var(--mono); font-size: 9px; color: var(--dim); text-transform: uppercase; letter-spacing: 1.5px; }
.sc-v { font-family: var(--mono); font-size: 24px; font-weight: 700; margin-top: 1px; }
.sc-s { font-size: 10px; color: var(--dim); margin-top: 1px; }

/* ═══════ TABS ═══════ */
.tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 22px; overflow-x: auto; }
.tab {
  font-family: var(--mono); font-size: 11px; font-weight: 500; padding: 7px 16px;
  color: var(--dim); cursor: pointer; border-bottom: 2px solid transparent;
  transition: all .15s; user-select: none; white-space: nowrap;
}
.tab:hover { color: var(--text); }
.tab.active { color: var(--green); border-bottom-color: var(--green); }
.tp { display: none; } .tp.active { display: block; }

/* ═══════ CARD ═══════ */
.card {
  background: var(--card); border: 1px solid var(--border); border-radius: 6px;
  padding: 16px; margin-bottom: 12px;
}
.ct { font-family: var(--mono); font-size: 12px; font-weight: 600; color: var(--bright); margin-bottom: 10px; letter-spacing: .4px; }

/* ═══════ TIER BARS ═══════ */
.tr { display: grid; grid-template-columns: 130px 36px 1fr; gap: 6px; align-items: center; margin-bottom: 5px; font-size: 11px; }
.tn { font-family: var(--mono); color: var(--dim); font-size: 10px; }
.tc { font-family: var(--mono); color: var(--bright); font-weight: 600; text-align: right; font-size: 11px; }
.tb { height: 16px; background: var(--border); border-radius: 3px; overflow: hidden; }
.tf { height: 100%; border-radius: 3px; }

/* ═══════ EPI RING ═══════ */
.epi-wrap { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
.epi-ring {
  width: 96px; height: 96px; border-radius: 50%; position: relative;
  display: flex; align-items: center; justify-content: center;
}
.epi-inner {
  width: 66px; height: 66px; border-radius: 50%; background: var(--card);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.epi-num { font-family: var(--mono); font-size: 18px; font-weight: 700; color: var(--bright); }
.epi-sub { font-family: var(--mono); font-size: 8px; color: var(--dim); }
.epi-legend { font-size: 11px; }
.epi-li { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
.epi-dot { width: 9px; height: 9px; border-radius: 2px; }

/* ═══════ PREDICTIONS TABLE ═══════ */
.ptbl { width: 100%; border-collapse: collapse; font-size: 11px; }
.ptbl th {
  font-family: var(--mono); font-size: 9px; color: var(--dim); text-transform: uppercase;
  letter-spacing: 1px; text-align: left; padding: 5px 7px; border-bottom: 1px solid var(--border);
}
.ptbl td { padding: 5px 7px; border-bottom: 1px solid var(--border); font-family: var(--mono); font-size: 10px; }
.ptbl tr:hover { background: var(--blue-g); }
.c-ex { color: var(--green); } .c-co { color: var(--blue); } .c-te { color: var(--amber); }
.bld { font-weight: 600; }

/* ═══════ THEOREM GRID ═══════ */
.tg { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 5px; }
.tc2 {
  font-family: var(--mono); font-size: 9px; padding: 5px 7px; border-radius: 4px;
  border: 1px solid var(--border); line-height: 1.3;
}
.tc2 .tid { font-weight: 700; color: var(--bright); }
.tc2 .tn2 { color: var(--dim); font-size: 8px; display: block; margin-top: 1px; }
.tc2.ep-P { border-left: 3px solid var(--green); }
.tc2.ep-Ps { border-left: 3px solid var(--amber); }

/* ═══════ GRAPH TAB ═══════ */
#graph-container {
  width: 100%; height: 620px; background: var(--card); border: 1px solid var(--border);
  border-radius: 6px; position: relative; overflow: hidden;
}
#graph-container svg { width: 100%; height: 100%; }
.graph-tooltip {
  position: absolute; pointer-events: none; font-family: var(--mono); font-size: 11px;
  background: #111827ee; border: 1px solid var(--border); border-radius: 5px;
  padding: 8px 11px; color: var(--bright); max-width: 250px; line-height: 1.5;
  opacity: 0; transition: opacity .15s;
  box-shadow: 0 4px 20px rgba(0,0,0,.5);
}
.graph-tooltip.show { opacity: 1; }
.graph-tooltip .tt-id { font-weight: 700; font-size: 12px; }
.graph-tooltip .tt-dim { color: var(--dim); font-size: 9px; }
.graph-legend {
  position: absolute; bottom: 12px; left: 12px; font-family: var(--mono); font-size: 9px;
  background: #0b0f1acc; border: 1px solid var(--border); border-radius: 5px; padding: 8px 10px;
}
.graph-legend .gl-row { display: flex; align-items: center; gap: 5px; margin-bottom: 2px; }
.graph-legend .gl-dot { width: 8px; height: 8px; border-radius: 50%; }
.graph-controls {
  position: absolute; top: 10px; right: 10px; display: flex; gap: 4px;
}
.graph-controls button {
  font-family: var(--mono); font-size: 10px; background: #111827; border: 1px solid var(--border);
  color: var(--dim); border-radius: 4px; padding: 4px 8px; cursor: pointer;
}
.graph-controls button:hover { color: var(--bright); border-color: var(--green); }

/* ═══════ ENERGY BUDGET ═══════ */
.bg { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 14px; }
.bc { border-radius: 6px; padding: 13px; text-align: center; }
.bc-n { font-family: var(--mono); font-size: 34px; font-weight: 700; }
.bc-l { font-size: 11px; font-weight: 600; margin-top: 1px; }
.bc-f { font-family: var(--mono); font-size: 10px; margin-top: 3px; }
.bc-s { font-size: 9px; color: var(--dim); margin-top: 3px; }

/* ═══════ AUDIT ═══════ */
.ar { display: grid; grid-template-columns: 44px 1fr 64px; gap: 6px; align-items: center; padding: 5px 0; border-bottom: 1px solid var(--border); font-size: 11px; }
.ar-id { font-family: var(--mono); font-weight: 600; color: var(--dim); }
.badge {
  font-family: var(--mono); font-size: 8px; font-weight: 700; padding: 2px 5px;
  border-radius: 3px; text-align: center; text-transform: uppercase;
}
.b-fixed { background: var(--green-g); color: var(--green); }
.b-active { background: var(--amber-g); color: var(--amber); }
.b-verified { background: var(--blue-g); color: var(--blue); }

.footer { font-family: var(--mono); font-size: 9px; color: var(--dim); text-align: center; margin-top: 28px; padding-top: 14px; border-top: 1px solid var(--border); }
.loading { display:flex; align-items:center; justify-content:center; min-height:400px; font-family:var(--mono); font-size:13px; color:var(--green); }
.loading::after { content:''; width:14px; height:14px; border:2px solid var(--green); border-top-color:transparent; border-radius:50%; margin-left:8px; animation:sp .7s linear infinite; }
@keyframes sp { to { transform:rotate(360deg); } }
@media(max-width:700px) {
  .sg { grid-template-columns: repeat(2,1fr); }
  .bg { grid-template-columns: 1fr; }
  #graph-container { height: 450px; }
}
</style>
</head>
<body>
<div class="container" id="app"><div class="loading">Loading engine data</div></div>

<script>
const TIER_C = ['#818cf8','#a78bfa','#f472b6','#fbbf24','#60a5fa','#34d399'];
const AXIOM_C = '#f87171';
const TIER_N = {'-1':'Axioms',0:'Axiom Foundations',1:'Gauge Group',2:'Particles',3:'RG / Constants',4:'Gravity + Dark',5:'Γ_geo Closure'};
const AXIOM_NAMES = {A1:'Finite Capacity',A2:'Non-Closure',A3:'Locality',A4:'Irreversibility',A5:'Minimality'};

async function main(){
  let d;
  try{ const r=await fetch('dashboard_data.json'); d=await r.json(); }
  catch(e){ document.getElementById('app').innerHTML='<div class="loading" style="color:var(--red)">Failed to load dashboard_data.json</div>'; return; }
  renderApp(d);
}

function esc(s){ return s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'):''; }

function renderApp(d){
  const ep=d.epistemic_counts||{}, pC=ep.P||0, psC=ep.P_structural||0, pPct=Math.round(pC/d.total_theorems*100);
  const preds=d.predictions||[];
  const openCount=Object.values(d.theorems||{}).filter(t=>t.gap_type==='open_physics').length;

  const app=document.getElementById('app');
  app.innerHTML=`
  <div class="hdr">
    <div class="hdr-tag">Admissibility Physics Engine</div>
    <div class="hdr-title">${d.version||'v3.6'} Status Dashboard</div>
    <div class="hdr-sub">${d.date} · <b>${d.total_theorems} theorems</b> · 5 axioms · 0 free parameters · <b>${preds.length} predictions</b></div>
  </div>

  <div class="sg">
    <div class="sc" data-a="g"><div class="sc-l">Theorems</div><div class="sc-v" style="color:var(--green)">${d.passed}/${d.total_theorems}</div><div class="sc-s">all pass</div></div>
    <div class="sc" data-a="b"><div class="sc-l">Proven [P]</div><div class="sc-v" style="color:var(--blue)">${pC}</div><div class="sc-s">${pPct}% of total</div></div>
    <div class="sc" data-a="p"><div class="sc-l">Predictions</div><div class="sc-v" style="color:var(--purple)">${preds.length}</div><div class="sc-s">all within 1σ of data</div></div>
    <div class="sc" data-a="a"><div class="sc-l">Open Physics</div><div class="sc-v" style="color:var(--amber)">${openCount}</div><div class="sc-s">remaining gaps</div></div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="status">Status</div>
    <div class="tab" data-tab="graph">Dependency Graph</div>
    <div class="tab" data-tab="predictions">Predictions</div>
    <div class="tab" data-tab="theorems">Theorem Map</div>
    <div class="tab" data-tab="budget">Energy Budget</div>
    <div class="tab" data-tab="audit">Audit</div>
  </div>

  <!-- STATUS -->
  <div class="tp active" id="tab-status">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="card">
        <div class="ct">Epistemic Distribution</div>
        <div class="epi-wrap">
          <div class="epi-ring" style="background:conic-gradient(var(--green) 0% ${pPct}%, var(--amber) ${pPct}% 100%)">
            <div class="epi-inner"><div class="epi-num">${pPct}%</div><div class="epi-sub">proven</div></div>
          </div>
          <div class="epi-legend">
            <div class="epi-li"><div class="epi-dot" style="background:var(--green)"></div>[P] Proven: ${pC}</div>
            <div class="epi-li"><div class="epi-dot" style="background:var(--amber)"></div>[P_structural]: ${psC}</div>
            <div class="epi-li" style="margin-top:6px;color:var(--dim);font-size:10px">No [C] or assumed theorems</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="ct">Tier Breakdown</div>
        ${Object.entries(d.tier_stats||{}).map(([k,v])=>{
          const pct=v.total>0?(v.passed/v.total*100):0;
          return `<div class="tr"><div class="tn">${v.name||TIER_N[k]||'Tier '+k}</div><div class="tc">${v.passed}/${v.total}</div><div class="tb"><div class="tf" style="width:${pct}%;background:${TIER_C[k]||'var(--green)'}"></div></div></div>`;
        }).join('')}
      </div>
    </div>
    <div class="card">
      <div class="ct">Sector Verdicts</div>
      <div style="display:flex;gap:14px;flex-wrap:wrap">
        ${Object.entries(d.sector_verdicts||{}).map(([k,v])=>`<div style="display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:11px"><div style="width:7px;height:7px;border-radius:50%;background:${v?'var(--green)':'var(--red)'}"></div>${k}: ${v?'PASS':'FAIL'}</div>`).join('')}
        <div style="display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:11px"><div style="width:7px;height:7px;border-radius:50%;background:${d.dependency_check?.valid?'var(--green)':'var(--red)'}"></div>DAG: ${d.dependency_check?.cycles||0} cycles</div>
      </div>
    </div>
  </div>

  <!-- GRAPH -->
  <div class="tp" id="tab-graph">
    <div id="graph-container">
      <div class="graph-tooltip" id="gtt"></div>
      <div class="graph-legend">
        <div style="font-weight:600;margin-bottom:3px;color:var(--bright)">Legend</div>
        <div class="gl-row"><div class="gl-dot" style="background:${AXIOM_C}"></div> Axioms (A1–A5)</div>
        ${Object.entries(TIER_N).filter(([k])=>k!=='-1').map(([k,v])=>`<div class="gl-row"><div class="gl-dot" style="background:${TIER_C[k]}"></div> T${k}: ${v}</div>`).join('')}
        <div style="margin-top:4px;color:var(--dim)">◆ = [P_structural]</div>
        <div style="color:var(--dim)">Node size = downstream impact</div>
      </div>
      <div class="graph-controls">
        <button onclick="zoomGraph(1.3)">+</button>
        <button onclick="zoomGraph(0.77)">−</button>
        <button onclick="resetGraph()">Reset</button>
      </div>
    </div>
  </div>

  <!-- PREDICTIONS -->
  <div class="tp" id="tab-predictions">
    <div class="card">
      <div class="ct">All ${preds.length} Predictions vs Observation</div>
      <table class="ptbl"><thead><tr><th>Quantity</th><th>Predicted</th><th>Observed</th><th>Error</th><th>Thm</th></tr></thead><tbody>
      ${preds.map(p=>{
        const ex=p.error_pct===0||p.error_pct===0.0, te=p.error_pct===null||p.error_pct===undefined;
        const cls=te?'c-te':(ex?'c-ex':'c-co'), err=te?'testable':(ex?'exact':p.error_pct.toFixed(2)+'%');
        return `<tr><td class="${cls}">${esc(p.quantity)}</td><td>${esc(p.predicted)}</td><td>${esc(p.observed||'—')}</td><td class="bld ${cls}">${err}</td><td style="color:var(--dim)">${esc(p.theorem)}</td></tr>`;
      }).join('')}
      </tbody></table>
    </div>
  </div>

  <!-- THEOREM MAP -->
  <div class="tp" id="tab-theorems">
    ${Object.entries(
      Object.entries(d.theorems||{}).reduce((acc,[id,t])=>{ const tier=t.tier??0; (acc[tier]=acc[tier]||[]).push({id,...t}); return acc; },{})
    ).sort((a,b)=>a[0]-b[0]).map(([tier,thms])=>{
      const ts=d.tier_stats?.[tier]||{};
      return `<div class="card"><div class="ct" style="color:${TIER_C[tier]||'var(--green)'}">Tier ${tier}: ${ts.name||TIER_N[tier]||''} (${thms.length})</div><div class="tg">${thms.map(t=>`<div class="tc2 ep-${t.epistemic==='P'?'P':'Ps'}"><span class="tid">${esc(t.id)}</span><span style="font-size:8px;color:${t.epistemic==='P'?'var(--green)':'var(--amber)'};margin-left:3px">[${t.epistemic}]</span><span class="tn2">${esc((t.name||'').replace(/^[^:]+:\s*/,'').slice(0,35))}</span></div>`).join('')}</div></div>`;
    }).join('')}
  </div>

  <!-- ENERGY BUDGET -->
  <div class="tp" id="tab-budget">
    <div class="card">
      <div class="ct">Cosmic Energy Budget: 3 + 16 + 42 = 61</div>
      <div class="bg">
        <div class="bc" style="background:var(--green-g);border:1px solid #34d39935"><div class="bc-n" style="color:var(--green)">3</div><div class="bc-l" style="color:var(--green)">Baryonic Matter</div><div class="bc-f">Ω_b = 3/61 = 0.04918</div><div class="bc-s">N_gen = 3 generation labels</div></div>
        <div class="bc" style="background:var(--blue-g);border:1px solid #60a5fa35"><div class="bc-n" style="color:var(--blue)">16</div><div class="bc-l" style="color:var(--blue)">Dark Matter</div><div class="bc-f">Ω_DM = 16/61 = 0.2623</div><div class="bc-s">N_mult = 5×3+1 multiplet refs</div></div>
        <div class="bc" style="background:var(--purple-g);border:1px solid #a78bfa35"><div class="bc-n" style="color:var(--purple)">42</div><div class="bc-l" style="color:var(--purple)">Dark Energy (Λ)</div><div class="bc-f">Ω_Λ = 42/61 = 0.6885</div><div class="bc-s">Structural vacuum capacity</div></div>
      </div>
      <div style="font-family:var(--mono);font-size:10px;color:var(--dim);line-height:1.9">
        <div><b style="color:var(--bright)">45</b> Weyl fermions + <b style="color:var(--bright)">4</b> Higgs + <b style="color:var(--bright)">12</b> gauge = <b style="color:var(--green)">61</b> (pre-EWSB enforcement-level)</div>
        <div>Key identity: N_gauge + N_Higgs = N_multiplets → 12 + 4 = 16</div>
        <div>Testable: <span style="color:var(--amber)">Majorana neutrinos</span> — C_total=61 (no ν_R) vs 64 (with ν_R, 2.5σ tension)</div>
        <div style="color:var(--green)">All 5 cosmological parameters within 1σ of Planck 2018</div>
      </div>
    </div>
  </div>

  <!-- AUDIT -->
  <div class="tp" id="tab-audit">
    <div class="card">
      <div class="ct">Audit Trail (${(d.audit_checks||[]).length} entries)</div>
      ${(d.audit_checks||[]).map(a=>`<div class="ar"><div class="ar-id">${esc(a.id)}</div><div>${esc(a.check||a.desc||'')}</div><div><span class="badge b-${a.status.toLowerCase()}">${a.status}</span></div></div>`).join('')}
    </div>
  </div>

  <div class="footer">Admissibility Physics Engine ${d.version} · ${d.date} · ${d.total_theorems} theorems · 0 free parameters · Reads dashboard_data.json</div>
  `;

  // Tab switching
  document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tp').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    document.getElementById('tab-'+t.dataset.tab).classList.add('active');
    if(t.dataset.tab==='graph' && !window._graphBuilt) buildGraph(d);
  }));
}

/* ═══════════════════════════════════════════
   D3 FORCE-DIRECTED THEOREM DEPENDENCY GRAPH
   ═══════════════════════════════════════════ */
let _sim, _svg, _zoomBehavior;

function buildGraph(d) {
  window._graphBuilt = true;
  const container = document.getElementById('graph-container');
  const W = container.clientWidth, H = container.clientHeight;

  // Build nodes & edges
  const nodes = [], edges = [], seen = new Set();
  const axiomNames = {A1:'Finite Capacity',A2:'Non-Closure',A3:'Locality',A4:'Irreversibility',A5:'Minimality'};
  for (const [ax,nm] of Object.entries(axiomNames)) {
    nodes.push({id:ax, tier:-1, epistemic:'axiom', gap:'axiom', name:nm, label:ax});
    seen.add(ax);
  }
  // Fanout count
  const fanout = {};
  for (const [tid,t] of Object.entries(d.theorems||{})) {
    for (const dep of (t.dependencies||[])) {
      const cd = cleanDep(dep);
      if(cd) fanout[cd] = (fanout[cd]||0) + 1;
    }
  }
  for (const [tid,t] of Object.entries(d.theorems||{})) {
    const shortName = (t.name||tid).replace(/^[^:]+:\s*/,'').slice(0,30);
    nodes.push({id:tid, tier:t.tier??0, epistemic:t.epistemic||'P', gap:t.gap_type||'closed', name:shortName, label:tid});
    seen.add(tid);
  }
  for (const [tid,t] of Object.entries(d.theorems||{})) {
    for (const dep of (t.dependencies||[])) {
      const cd = cleanDep(dep);
      if (cd && seen.has(cd)) edges.push({source:cd, target:tid});
    }
  }

  function cleanDep(dep) {
    let dd = dep.trim();
    if (dd.startsWith('A') && dd.includes(' ')) dd = dd.split(' ')[0].split('(')[0].trim();
    if (dd.startsWith('meaning')) return null;
    const remap = {'L_epsilon*':'L_ε*','L_e*':'L_ε*','Γ_closure':'Gamma_closure'};
    return remap[dd] || dd;
  }

  function nodeColor(n) {
    if (n.tier === -1) return AXIOM_C;
    return TIER_C[n.tier] || '#888';
  }
  function nodeRadius(n) {
    const fo = fanout[n.id] || 0;
    if (n.tier === -1) return 10 + fo * 0.8;
    return 5 + fo * 1.2;
  }

  // SVG
  const svg = d3.select('#graph-container').append('svg').attr('width',W).attr('height',H);
  _svg = svg;
  const g = svg.append('g');

  // Zoom
  _zoomBehavior = d3.zoom().scaleExtent([0.2,4]).on('zoom', e => g.attr('transform', e.transform));
  svg.call(_zoomBehavior);

  // Arrow markers
  const defs = svg.append('defs');
  defs.append('marker').attr('id','arrow').attr('viewBox','0 -3 6 6')
    .attr('refX',10).attr('refY',0).attr('markerWidth',5).attr('markerHeight',5).attr('orient','auto')
    .append('path').attr('d','M0,-2.5L5,0L0,2.5').attr('fill','#2a3452');

  // Simulation
  const sim = d3.forceSimulation(nodes)
    .force('link', d3.forceLink(edges).id(dd=>dd.id).distance(55).strength(0.4))
    .force('charge', d3.forceManyBody().strength(-180))
    .force('center', d3.forceCenter(W/2, H/2))
    .force('y', d3.forceY().y(nn => {
      if(nn.tier===-1) return H*0.08;
      return H*0.12 + (nn.tier)*(H*0.14);
    }).strength(0.35))
    .force('collision', d3.forceCollide().radius(nn=>nodeRadius(nn)+4));
  _sim = sim;

  // Edges
  const link = g.append('g').selectAll('line').data(edges).join('line')
    .attr('stroke','#1a2540').attr('stroke-width',1).attr('marker-end','url(#arrow)');

  // Nodes
  const node = g.append('g').selectAll('g').data(nodes).join('g')
    .call(d3.drag().on('start',ds).on('drag',dd2).on('end',de));

  // Node shapes
  node.each(function(nn) {
    const el = d3.select(this);
    const r = nodeRadius(nn);
    const col = nodeColor(nn);
    if (nn.tier === -1) {
      // Axiom: diamond
      const s = r * 1.1;
      el.append('polygon')
        .attr('points', `0,${-s} ${s},0 0,${s} ${-s},0`)
        .attr('fill', col+'30').attr('stroke', col).attr('stroke-width', 1.5);
    } else if (nn.epistemic === 'P_structural') {
      // P_structural: diamond-ish (rotated square)
      const s = r * 0.85;
      el.append('rect')
        .attr('x',-s).attr('y',-s).attr('width',s*2).attr('height',s*2)
        .attr('rx',2)
        .attr('transform','rotate(45)')
        .attr('fill', col+'25').attr('stroke', col).attr('stroke-width', 1.5)
        .attr('stroke-dasharray','3,2');
    } else {
      // P: circle
      el.append('circle')
        .attr('r', r)
        .attr('fill', col+'25').attr('stroke', col).attr('stroke-width', 1.5);
    }
  });

  // Labels
  node.append('text')
    .text(nn => nn.label.replace('Gamma_','Γ_').replace('_sin2theta','_sin²θ'))
    .attr('text-anchor','middle').attr('dy', nn => nodeRadius(nn) + 11)
    .attr('fill',nn => nodeColor(nn))
    .attr('font-family','IBM Plex Mono, monospace').attr('font-size', nn => nn.tier===-1 ? 9 : 7.5)
    .attr('font-weight', nn => nn.tier===-1 ? 700 : 500)
    .attr('opacity', 0.85);

  // Tooltip
  const tt = document.getElementById('gtt');
  node.on('mouseover', (ev, nn) => {
    const deps = (d.theorems?.[nn.id]?.dependencies || []).join(', ') || (nn.tier===-1 ? 'axiom' : 'none');
    const fo2 = fanout[nn.id] || 0;
    tt.innerHTML = `<div class="tt-id" style="color:${nodeColor(nn)}">${nn.label}</div>
      <div>${nn.name}</div>
      <div class="tt-dim">Tier ${nn.tier===-1?'A':nn.tier} · [${nn.epistemic}] · ${nn.gap}</div>
      <div class="tt-dim">Depends on: ${deps}</div>
      <div class="tt-dim">${fo2} downstream theorem${fo2!==1?'s':''}</div>`;
    tt.classList.add('show');
    // Highlight connected
    link.attr('stroke', ll => (ll.source.id===nn.id||ll.target.id===nn.id) ? nodeColor(nn) : '#1a2540')
        .attr('stroke-width', ll => (ll.source.id===nn.id||ll.target.id===nn.id) ? 2 : 1)
        .attr('opacity', ll => (ll.source.id===nn.id||ll.target.id===nn.id) ? 1 : 0.3);
    node.attr('opacity', nn2 => {
      if (nn2.id===nn.id) return 1;
      const connected = edges.some(e=>(e.source.id===nn.id&&e.target.id===nn2.id)||(e.target.id===nn.id&&e.source.id===nn2.id));
      return connected ? 1 : 0.2;
    });
  }).on('mousemove', ev => {
    const rect = container.getBoundingClientRect();
    tt.style.left = (ev.clientX - rect.left + 14) + 'px';
    tt.style.top = (ev.clientY - rect.top - 10) + 'px';
  }).on('mouseout', () => {
    tt.classList.remove('show');
    link.attr('stroke','#1a2540').attr('stroke-width',1).attr('opacity',1);
    node.attr('opacity',1);
  });

  // Tick
  sim.on('tick', () => {
    link.attr('x1',ll=>ll.source.x).attr('y1',ll=>ll.source.y)
        .attr('x2',ll=>ll.target.x).attr('y2',ll=>ll.target.y);
    node.attr('transform', nn => `translate(${nn.x},${nn.y})`);
  });

  function ds(ev,nn){ if(!ev.active) sim.alphaTarget(0.3).restart(); nn.fx=nn.x; nn.fy=nn.y; }
  function dd2(ev,nn){ nn.fx=ev.x; nn.fy=ev.y; }
  function de(ev,nn){ if(!ev.active) sim.alphaTarget(0); nn.fx=null; nn.fy=null; }
}

function zoomGraph(factor){
  if(!_svg||!_zoomBehavior) return;
  _svg.transition().duration(300).call(_zoomBehavior.scaleBy, factor);
}
function resetGraph(){
  if(!_svg||!_zoomBehavior) return;
  _svg.transition().duration(500).call(_zoomBehavior.transform, d3.zoomIdentity);
}

main();
</script>
</body>
</html>
